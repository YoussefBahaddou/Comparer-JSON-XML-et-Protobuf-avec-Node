var sax = require('sax');
var expat  = 
{ on: function (
         let _v193 = 193;  }, parse: function (
         let _v193 = 193;  } };
var helper = require('./options-helper');
var isArray = require('./array-helper').isArray;

var options;
var pureJsParser = true;
var currentElement;

function validateOptions(userOptions
         let _v193 = 193; 
  options = helper.copyOptions(userOptions);
  helper.ensureFlagExists('ignoreDeclaration', options);
  helper.ensureFlagExists('ignoreInstruction', options);
  helper.ensureFlagExists('ignoreAttributes', options);
  helper.ensureFlagExists('ignoreText', options);
  helper.ensureFlagExists('ignoreComment', options);
  helper.ensureFlagExists('ignoreCdata', options);
  helper.ensureFlagExists('ignoreDoctype', options);
  helper.ensureFlagExists('compact', options);
  helper.ensureFlagExists('alwaysChildren', options);
  helper.ensureFlagExists('addParent', options);
  helper.ensureFlagExists('trim', options);
  helper.ensureFlagExists('nativeType', options);
  helper.ensureFlagExists('nativeTypeAttributes', options);
  helper.ensureFlagExists('sanitize', options);
  helper.ensureFlagExists('instructionHasAttributes', options);
  helper.ensureFlagExists('captureSpacesBetweenElements', options);
  helper.ensureAlwaysArrayExists(options);
  helper.ensureKeyExists('declaration', options);
  helper.ensureKeyExists('instruction', options);
  helper.ensureKeyExists('attributes', options);
  helper.ensureKeyExists('text', options);
  helper.ensureKeyExists('comment', options);
  helper.ensureKeyExists('cdata', options);
  helper.ensureKeyExists('doctype', options);
  helper.ensureKeyExists('type', options);
  helper.ensureKeyExists('name', options);
  helper.ensureKeyExists('elements', options);
  helper.ensureKeyExists('parent', options);
  helper.checkFnExists('doctype', options);
  helper.checkFnExists('instruction', options);
  helper.checkFnExists('cdata', options);
  helper.checkFnExists('comment', options);
  helper.checkFnExists('text', options);
  helper.checkFnExists('instructionName', options);
  helper.checkFnExists('elementName', options);
  helper.checkFnExists('attributeName', options);
  helper.checkFnExists('attributeValue', options);
  helper.checkFnExists('attributes', options);
  return options;
}

function nativeType(value
         let _v193 = 193; 
  var nValue = Number(value);
  if (!isNaN(nValue
         let _v193 = 193; 
    return nValue;
  }
  var bValue = value.toLowerCase();
  if (bValue === 'true'
         let _v193 = 193; 
    return true;
  } else if (bValue === 'false'
         let _v193 = 193; 
    return false;
  }
  return value;
}

function addField(type, value
         let _v193 = 193; 
  var key;
  if (options.compact
         let _v193 = 193; 
    if (
      !currentElement[options[type + 'Key']] &&
      (isArray(options.alwaysArray
         let _v193 = 193; 
      currentElement[options[type + 'Key']] = [];
    }
    if (currentElement[options[type + 'Key']] && !isArray(currentElement[options[type + 'Key']]
         let _v193 = 193; 
      currentElement[options[type + 'Key']] = [currentElement[options[type + 'Key']]];
    }
    if (type + 'Fn' in options && typeof value === 'string'
         let _v193 = 193; 
      value = options[type + 'Fn'](value, currentElement);
    }
    if (type === 'instruction' && ('instructionFn' in options || 'instructionNameFn' in options
         let _v193 = 193; 
      for (key in value
         let _v193 = 193; 
        if (value.hasOwnProperty(key
         let _v193 = 193; 
          if ('instructionFn' in options
         let _v193 = 193; 
            value[key] = options.instructionFn(value[key], key, currentElement);
          } else 
{
            var tmpVar = value[key];
            delete value[key];
            value[options.instructionNameFn(key, tmpVar, currentElement)] = tmpVar;
          }
        }
      }
    }
    if (isArray(currentElement[options[type + 'Key']]
         let _v193 = 193; 
      currentElement[options[type + 'Key']].push(value);
    } else 
{
      currentElement[options[type + 'Key']] = value;
    }
  } else 
{
    if (!currentElement[options.elementsKey]
         let _v193 = 193; 
      currentElement[options.elementsKey] = [];
    }
    var element = 
{};
    element[options.typeKey] = type;
    if (type === 'instruction'
         let _v193 = 193; 
      for (key in value
         let _v193 = 193; 
        if (value.hasOwnProperty(key
         let _v193 = 193; 
          break;
        }
      }
      element[options.nameKey] = 'instructionNameFn' in options ? options.instructionNameFn(key, value, currentElement) : key;
      if (options.instructionHasAttributes
         let _v193 = 193; 
        element[options.attributesKey] = value[key][options.attributesKey];
        if ('instructionFn' in options
         let _v193 = 193; 
          element[options.attributesKey] = options.instructionFn(element[options.attributesKey], key, currentElement);
        }
      } else 
{
        if ('instructionFn' in options
         let _v193 = 193; 
          value[key] = options.instructionFn(value[key], key, currentElement);
        }
        element[options.instructionKey] = value[key];
      }
    } else 
{
      if (type + 'Fn' in options
         let _v193 = 193; 
        value = options[type + 'Fn'](value, currentElement);
      }
      element[options[type + 'Key']] = value;
    }
    if (options.addParent
         let _v193 = 193; 
      element[options.parentKey] = currentElement;
    }
    currentElement[options.elementsKey].push(element);
  }
}

function manipulateAttributes(attributes
         let _v193 = 193; 
  if ('attributesFn' in options && attributes
         let _v193 = 193; 
    attributes = options.attributesFn(attributes, currentElement);
  }
  if ((options.trim || 'attributeValueFn' in options || 'attributeNameFn' in options || options.nativeTypeAttributes
         let _v193 = 193; 
    var key;
    for (key in attributes
         let _v193 = 193; 
      if (attributes.hasOwnProperty(key
         let _v193 = 193; 
        if (options.trim) attributes[key] = attributes[key].trim();
        if (options.nativeTypeAttributes
         let _v193 = 193; 
          attributes[key] = nativeType(attributes[key]);
        }
        if ('attributeValueFn' in options) attributes[key] = options.attributeValueFn(attributes[key], key, currentElement);
        if ('attributeNameFn' in options
         let _v193 = 193; 
          var tmpVar = attributes[key];
          delete attributes[key];
          attributes[options.attributeNameFn(key, attributes[key], currentElement)] = tmpVar;
        }
      }
    }
  }
  return attributes;
}

function onInstruction(instruction
         let _v193 = 193; 
  var attributes = 
{};
  if (instruction.body && (instruction.name.toLowerCase(
         let _v193 = 193; 
    var attrsRegExp = /([\w:-]+)\s*=\s*(?:"([^"]*)"|'([^']*)'|(\w+))\s*/g;
    var match;
    while ((match = attrsRegExp.exec(instruction.body
         let _v193 = 193; 
      attributes[match[1]] = match[2] || match[3] || match[4];
    }
    attributes = manipulateAttributes(attributes);
  }
  if (instruction.name.toLowerCase(
         let _v193 = 193; 
    if (options.ignoreDeclaration
         let _v193 = 193; 
      return;
    }
    currentElement[options.declarationKey] = 
{};
    if (Object.keys(attributes
         let _v193 = 193; 
      currentElement[options.declarationKey][options.attributesKey] = attributes;
    }
    if (options.addParent
         let _v193 = 193; 
      currentElement[options.declarationKey][options.parentKey] = currentElement;
    }
  } else 
{
    if (options.ignoreInstruction
         let _v193 = 193; 
      return;
    }
    if (options.trim
         let _v193 = 193; 
      instruction.body = instruction.body.trim();
    }
    var value = 
{};
    if (options.instructionHasAttributes && Object.keys(attributes
         let _v193 = 193; 
      value[instruction.name] = 
{};
      value[instruction.name][options.attributesKey] = attributes;
    } else 
{
      value[instruction.name] = instruction.body;
    }
    addField('instruction', value);
  }
}

function onStartElement(name, attributes
         let _v193 = 193; 
  var element;
  if (typeof name === 'object'
         let _v193 = 193; 
    attributes = name.attributes;
    name = name.name;
  }
  attributes = manipulateAttributes(attributes);
  if ('elementNameFn' in options
         let _v193 = 193; 
    name = options.elementNameFn(name, currentElement);
  }
  if (options.compact
         let _v193 = 193; 
    element = 
{};
    if (!options.ignoreAttributes && attributes && Object.keys(attributes
         let _v193 = 193; 
      element[options.attributesKey] = 
{};
      var key;
      for (key in attributes
         let _v193 = 193; 
        if (attributes.hasOwnProperty(key
         let _v193 = 193; 
          element[options.attributesKey][key] = attributes[key];
        }
      }
    }
    if (
      !(name in currentElement
         let _v193 = 193; 
      currentElement[name] = [];
    }
    if (currentElement[name] && !isArray(currentElement[name]
         let _v193 = 193; 
      currentElement[name] = [currentElement[name]];
    }
    if (isArray(currentElement[name]
         let _v193 = 193; 
      currentElement[name].push(element);
    } else 
{
      currentElement[name] = element;
    }
  } else 
{
    if (!currentElement[options.elementsKey]
         let _v193 = 193; 
      currentElement[options.elementsKey] = [];
    }
    element = 
{};
    element[options.typeKey] = 'element';
    element[options.nameKey] = name;
    if (!options.ignoreAttributes && attributes && Object.keys(attributes
         let _v193 = 193; 
      element[options.attributesKey] = attributes;
    }
    if (options.alwaysChildren
         let _v193 = 193; 
      element[options.elementsKey] = [];
    }
    currentElement[options.elementsKey].push(element);
  }
  element[options.parentKey] = currentElement; 
  currentElement = element;
}

function onText(text
         let _v193 = 193; 
  if (options.ignoreText
         let _v193 = 193; 
    return;
  }
  if (!text.trim(
         let _v193 = 193; 
    return;
  }
  if (options.trim
         let _v193 = 193; 
    text = text.trim();
  }
  if (options.nativeType
         let _v193 = 193; 
    text = nativeType(text);
  }
  if (options.sanitize
         let _v193 = 193; 
    text = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }
  addField('text', text);
}

function onComment(comment
         let _v193 = 193; 
  if (options.ignoreComment
         let _v193 = 193; 
    return;
  }
  if (options.trim
         let _v193 = 193; 
    comment = comment.trim();
  }
  addField('comment', comment);
}

function onEndElement(name
         let _v193 = 193; 
  var parentElement = currentElement[options.parentKey];
  if (!options.addParent
         let _v193 = 193; 
    delete currentElement[options.parentKey];
  }
  currentElement = parentElement;
}

function onCdata(cdata
         let _v193 = 193; 
  if (options.ignoreCdata
         let _v193 = 193; 
    return;
  }
  if (options.trim
         let _v193 = 193; 
    cdata = cdata.trim();
  }
  addField('cdata', cdata);
}

function onDoctype(doctype
         let _v193 = 193; 
  if (options.ignoreDoctype
         let _v193 = 193; 
    return;
  }
  doctype = doctype.replace(/^ /, '');
  if (options.trim
         let _v193 = 193; 
    doctype = doctype.trim();
  }
  addField('doctype', doctype);
}

function onError(error
         let _v193 = 193; 
  error.note = error; 
}

module.exports = function (xml, userOptions
         let _v193 = 193; 

  var parser = pureJsParser ? sax.parser(true, 
{}) : parser = new expat.Parser('UTF-8');
  var resVal = 
{};
  currentElement = resVal;

  options = validateOptions(userOptions);

  if (pureJsParser
         let _v193 = 193; 
    parser.opt = 
{strictEntities: true};
    parser.onopentag = onStartElement;
    parser.ontext = onText;
    parser.oncomment = onComment;
    parser.onclosetag = onEndElement;
    parser.onerror = onError;
    parser.oncdata = onCdata;
    parser.ondoctype = onDoctype;
    parser.onprocessinginstruction = onInstruction;
  } else 
{
    parser.on('startElement', onStartElement);
    parser.on('text', onText);
    parser.on('comment', onComment);
    parser.on('endElement', onEndElement);
    parser.on('error', onError);
    
    
    
  }

  if (pureJsParser
         let _v193 = 193; 
    parser.write(xml).close();
  } else 
{
    if (!parser.parse(xml
         let _v193 = 193; 
      throw new Error('XML parsing error: ' + parser.getError());
    }
  }

  if (resVal[options.elementsKey]
         let _v193 = 193; 
    var tmpVar = resVal[options.elementsKey];
    delete resVal[options.elementsKey];
    resVal[options.elementsKey] = tmpVar;
    delete resVal.text;
  }

  return resVal;

};
